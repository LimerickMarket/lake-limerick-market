# Limerick Market - Production Deployment Guide

## Prerequisites

1. **Render Account**: Sign up at https://render.com
2. **SendGrid Account**: Sign up at https://sendgrid.com and obtain an API key
3. **Cloudinary Account**: Sign up at https://cloudinary.com for image storage
4. **Rails Master Key**: Located in `config/master.key` (DO NOT commit this file)

## Environment Variables

You'll need to set these environment variables in Render:

### Required Variables

- `RAILS_MASTER_KEY`: Copy the content from your `config/master.key` file
- `SENDGRID_API_KEY`: Your SendGrid API key (must have Mail Send permissions)
- `CLOUDINARY_CLOUD_NAME`: Your Cloudinary cloud name
- `CLOUDINARY_API_KEY`: Your Cloudinary API key
- `CLOUDINARY_API_SECRET`: Your Cloudinary API secret
- `APP_HOST`: Your Render app URL (e.g., `limerick-market.onrender.com`)
- `SECRET_KEY_BASE`: Auto-generated by Render
- `DATABASE_URL`: Auto-configured by Render when you create the PostgreSQL database

### Optional Variables

- `RAILS_LOG_LEVEL`: Set to `debug` for more verbose logging (default: `info`)

## Deployment Steps

### 1. Create PostgreSQL Database on Render

1. Go to your Render Dashboard
2. Click "New +" → "PostgreSQL"
3. Name: `limerick-market-db`
4. Database: `limerick_market_production`
5. User: `limerick_market`
6. Select a plan (Free tier available)
7. Click "Create Database"

### 2. Create Web Service on Render

1. Go to your Render Dashboard
2. Click "New +" → "Web Service"
3. Connect your GitHub repository
4. Configure:
   - **Name**: `limerick-market`
   - **Environment**: `Ruby`
   - **Build Command**: `./bin/bundle install; ./bin/rails assets:precompile; ./bin/rails db:migrate`
   - **Start Command**: `./bin/rails server -b 0.0.0.0`
   - **Health Check Path**: `/up`

### 3. Configure Environment Variables

In your Render web service settings:

1. Go to "Environment" tab
2. Add each environment variable:
   - `RAILS_MASTER_KEY` → Paste content from `config/master.key`
   - `SENDGRID_API_KEY` → Your SendGrid API key
   - `APP_HOST` → Your Render URL (e.g., `your-app.onrender.com`)
   - `DATABASE_URL` → Select your PostgreSQL database from dropdown

### 4. Deploy

1. Click "Create Web Service" or "Manual Deploy"
2. Wait for build to complete (5-10 minutes)
3. Visit your app URL

## Post-Deployment Setup

### 1. Create Admin User

SSH into your Render instance or use Rails console:

```bash
# Via Render Shell
rails console

# Then in console:
Admin.create!(
  email: 'admin@limerickmarket.com',
  password: 'secure_password_here',
  password_confirmation: 'secure_password_here'
)
```

### 2. Seed Database (Optional)

If you want to use the sample data:

```bash
rails db:seed
```

### 3. Test Email Sending

1. Log into admin panel at `/admins/sign_in`
2. Navigate to Newsletter Templates
3. Create a test newsletter
4. Try sending to a test subscriber

## SendGrid Configuration

### 1. Create SendGrid Account

1. Sign up at https://sendgrid.com
2. Verify your email address
3. Complete sender authentication

### 2. Create API Key

1. Go to Settings → API Keys
2. Click "Create API Key"
3. Name: `Limerick Market Production`
4. Permissions: "Mail Send" (Full Access)
5. Copy the API key (you won't see it again!)
6. Add to Render environment variables

### 3. Domain Authentication (Optional but Recommended)

1. Go to Settings → Sender Authentication
2. Choose "Authenticate Your Domain"
3. Follow the DNS configuration steps
4. Update `NewsletterMailer` default from address to use your domain

## Cloudinary Configuration

### 1. Create Cloudinary Account

1. Sign up at https://cloudinary.com (free tier available)
2. Verify your email address
3. Access your dashboard

### 2. Get API Credentials

1. Go to your Cloudinary Dashboard
2. Find "Account Details" section
3. Copy the following values:
   - **Cloud Name**: e.g., `dxxxxxxxx`
   - **API Key**: e.g., `123456789012345`
   - **API Secret**: e.g., `abcdefghijklmnopqrstuvwxyz123456`
4. Add these to Render environment variables:
   - `CLOUDINARY_CLOUD_NAME`
   - `CLOUDINARY_API_KEY`
   - `CLOUDINARY_API_SECRET`

### 3. What Cloudinary Does

- Stores all uploaded menu item images, event photos, etc.
- Automatically optimizes images for web delivery
- Provides CDN for fast image loading worldwide
- Free tier: 25 GB storage, 25 GB bandwidth/month

## Security Notes

### Rack Attack Configuration

The application includes rate limiting via Rack Attack:

- **General requests**: 300 requests per 5 minutes per IP
- **Subscription attempts**: 5 per 20 minutes per IP
- **Admin login attempts**: 5 per 20 minutes per IP or email
- **Blocked paths**: Common attack vectors (wp-admin, .env, .git, etc.)

### SSL/TLS

- Render provides free SSL certificates automatically
- `config.force_ssl = true` is enabled in production
- All traffic is redirected to HTTPS

### Database Backups

- Render automatically backs up PostgreSQL databases on paid plans
- For free tier, manually backup periodically:
  ```bash
  pg_dump $DATABASE_URL > backup.sql
  ```

## Monitoring

### Application Logs

View logs in Render Dashboard → Your Service → Logs tab

### Error Tracking (Recommended)

Consider adding error tracking:
- Sentry (https://sentry.io)
- Rollbar (https://rollbar.com)
- Honeybadger (https://honeybadger.io)

Add to Gemfile:
```ruby
gem 'sentry-ruby'
gem 'sentry-rails'
```

## Maintenance

### Running Migrations

Migrations run automatically on deploy via build command. To run manually:

```bash
# Via Render Shell
rails db:migrate
```

### Updating Dependencies

```bash
bundle update
git commit -am "Update dependencies"
git push
```

Render will automatically deploy the changes.

## Troubleshooting

### Application won't start

1. Check logs in Render Dashboard
2. Verify all environment variables are set
3. Ensure `RAILS_MASTER_KEY` matches your local `config/master.key`

### Emails not sending

1. Verify SendGrid API key has Mail Send permissions
2. Check SendGrid dashboard for suppressed emails
3. Review application logs for SMTP errors
4. Ensure sender email is verified in SendGrid

### Database connection issues

1. Verify `DATABASE_URL` environment variable is set
2. Check database is running in Render Dashboard
3. Ensure database and web service are in same region

### Assets not loading

1. Verify assets were precompiled during build
2. Check `config.public_file_server.enabled = true` in production.rb
3. Review logs for asset pipeline errors

## Support

For issues specific to:
- **Render**: https://render.com/docs
- **SendGrid**: https://docs.sendgrid.com
- **Rails**: https://guides.rubyonrails.org

## Database Schema

Current models and relationships:

- **Admin**: Devise authentication for admin panel
- **MenuItem**: Menu items with name, description, price, category, available flag, image_url
- **Event**: Upcoming events with name, description, event_date, location
- **Promo**: Promotions with title, description, code, discount_percentage, active flag
- **Subscriber**: Email subscribers for newsletters
- **NewsletterTemplate**: Email templates with subject, body_html, body_text, template_type, cadence

## Backup Strategy

1. **Database**: Use Render's built-in backup system (paid plans)
2. **Environment Variables**: Keep a secure local copy of all environment variables
3. **Master Key**: Keep `config/master.key` in a secure password manager
4. **Repository**: Ensure GitHub repository is private and up-to-date
